<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Time Logger</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; padding: 16px; background:#0b0c10; color:#e6edf3; }
    .wrap { max-width: 820px; margin: 0 auto; }
    h1 { margin: 0 0 12px; font-size: 18px; }
    .card { background:#12151c; border:1px solid #222a36; border-radius: 12px; padding: 14px; margin-bottom: 12px; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
    .time { font-variant-numeric: tabular-nums; font-size: 34px; letter-spacing: .5px; }
    button {
      background:#1f6feb; color:white; border:0; padding:10px 12px; border-radius:10px;
      cursor:pointer; font-weight: 600;
    }
    button.secondary { background:#2b313d; }
    button.danger { background:#da3633; }
    button:disabled { opacity: .5; cursor:not-allowed; }
    input[type="text"]{
      background:#0f131a; color:#e6edf3; border:1px solid #2b313d; border-radius:10px; padding:10px 12px;
      min-width: 240px;
    }
    .list { display:flex; flex-direction: column; gap:8px; margin-top: 10px; }
    .item {
      display:grid; grid-template-columns: 26px 1fr auto; gap:10px; align-items:center;
      background:#0f131a; border:1px solid #222a36; border-radius: 10px; padding:10px 10px;
    }
    .meta { display:flex; flex-direction: column; gap:4px; min-width: 0; }
    .meta small { color:#9aa4b2; }
    .meta .top { display:flex; gap:10px; align-items:center; }
    .meta .top .dur { font-variant-numeric: tabular-nums; font-weight: 700; }
    .meta .top input { min-width: 140px; max-width: 420px; width: 100%; }
    .actions { display:flex; gap:8px; }
    .summary { display:flex; justify-content: space-between; gap:10px; flex-wrap: wrap; }
    .pill { background:#0f131a; border:1px solid #222a36; border-radius: 999px; padding:8px 10px; }
    .muted { color:#9aa4b2; }
    .divider { height:1px; background:#222a36; margin: 10px 0; }
    .record-label{width: 100%; max-width: 420px; }

    @media (max-width: 650px) {
    body {
      padding: 10px;
    }

    .wrap {
      max-width: 650px;
    }

    .time {
      font-size: 26px;
      text-align: center;
      width: 100%;
    }

    .row {
      gap: 8px;
    }

    .card {
      padding: 12px;
    }

    /* タイマー操作ボタンを横いっぱいに */
    /* .row button {
      flex: 1;
    } */

    /* 記録リスト */
    .item {
      grid-template-columns: 24px 1fr;
      grid-template-rows: auto auto;
    }

    .actions {
      grid-column: 1 / -1;
      justify-content: flex-end;
    }

    .meta .top {
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
    }

    .meta .top .dur {
      font-size: 14px;
    }

    input[type="text"] {
      box-sizing: border-box;
      width: 100%;
      min-width: unset;
    }

    .summary {
      flex-direction: column;
      align-items: stretch;
    }

    .summary .row {
      justify-content: space-between;
    }

    .summary button {
      flex: 1;
    }

    /* .botan {
      display: flex;
      justify-content: center;
    } */

    .timerTop { justify-content: center !important; }
    .botan { justify-content: center; width: 100%; }
    .row button { flex: initial; } /* 伸びるのを止める */

    .record-label{ max-width: 50%; }
   }
  </style>
</head>
<body>
  <div class="wrap">
  <h1>Time Logger（計測→記録→選択合計）</h1>

  <div class="card">
    <div class="row timerTop" style="justify-content: space-between;">
      <div class="time" id="display">00:00:00.0</div>
      <div class="row botan">
        <button id="startBtn">Start</button>
        <button id="stopBtn" class="secondary" disabled>Stop & Save</button>
        <button id="resetBtn" class="secondary" disabled>Reset</button>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <input id="labelInput" type="text" placeholder="今回のラベル（例：英語、JS、筋トレ）" />
      <span class="muted">※ Stop時にこのラベルで保存（空でもOK）</span>
    </div>
  </div>

  <div class="card">
    <div class="summary">
      <div class="pill">選択件数：<b id="selCount">0</b></div>
      <div class="pill">選択合計：<b id="selTotal">00:00:00.0</b></div>
      <div class="row">
        <button id="selectAllBtn" class="secondary">全選択</button>
        <button id="clearSelBtn" class="secondary">選択解除</button>
        <button id="deleteSelBtn" class="danger">選択削除</button>
        <button id="clearAllBtn" class="danger">全削除</button>
      </div>
    </div>
  </div>

  <div class="list" id="list"></div>
</div>

<script>
(() => {
  // ===== Storage =====
  const KEY = "time_logger_records_v1";

  /** @type {{id:string,label:string,ms:number,createdAt:number,selected:boolean}[]} */
  let records = load();

  function load() {
    try {
      const raw = localStorage.getItem(KEY);
      const parsed = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(parsed)) return [];
      return parsed.map(r => ({
        id: String(r.id ?? crypto.randomUUID()),
        label: String(r.label ?? ""),
        ms: Number.isFinite(r.ms) ? r.ms : 0,
        createdAt: Number.isFinite(r.createdAt) ? r.createdAt : Date.now(),
        selected: !!r.selected,
      }));
    } catch {
      return [];
    }
  }

  function save() {
    localStorage.setItem(KEY, JSON.stringify(records));
  }

  // ===== Timer =====
  let running = false;
  let startAt = 0;      // performance.now()
  let elapsedMs = 0;    // accumulated ms
  let rafId = null;

  const display = document.getElementById("display");
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const resetBtn = document.getElementById("resetBtn");
  const labelInput = document.getElementById("labelInput");

  const listEl = document.getElementById("list");
  const selCountEl = document.getElementById("selCount");
  const selTotalEl = document.getElementById("selTotal");

  const selectAllBtn = document.getElementById("selectAllBtn");
  const clearSelBtn = document.getElementById("clearSelBtn");
  const deleteSelBtn = document.getElementById("deleteSelBtn");
  const clearAllBtn = document.getElementById("clearAllBtn");

  function fmt(ms) {
    const sign = ms < 0 ? "-" : "";
    ms = Math.abs(ms);

    const totalSec = Math.floor(ms / 1000);
    const h = Math.floor(totalSec / 3600);
    const m = Math.floor((totalSec % 3600) / 60);
    const s = totalSec % 60;
    const d1 = Math.floor((ms % 1000) / 100); // 0-9

    const hh = String(h).padStart(2, "0");
    const mm = String(m).padStart(2, "0");
    const ss = String(s).padStart(2, "0");
    return `${sign}${hh}:${mm}:${ss}.${d1}`;
  }

  function tick() {
    if (!running) return;
    const now = performance.now();
    const ms = elapsedMs + (now - startAt);
    display.textContent = fmt(ms);
    rafId = requestAnimationFrame(tick);
  }

  function setButtons() {
    startBtn.disabled = running;
    stopBtn.disabled = !running;
    resetBtn.disabled = running ? true : (elapsedMs === 0);
  }

  startBtn.addEventListener("click", () => {
    running = true;
    startAt = performance.now();
    setButtons();
    tick();
  });

  stopBtn.addEventListener("click", () => {
    if (!running) return;
    running = false;
    if (rafId) cancelAnimationFrame(rafId);

    const now = performance.now();
    const total = elapsedMs + (now - startAt);
    elapsedMs = 0;
    display.textContent = fmt(0);
    setButtons();

    const label = labelInput.value.trim();
    const rec = {
      id: crypto.randomUUID(),
      label,
      ms: Math.max(0, Math.round(total)),
      createdAt: Date.now(),
      selected: false
    };
    records.unshift(rec);
    save();
    render();
  });

  resetBtn.addEventListener("click", () => {
    running = false;
    if (rafId) cancelAnimationFrame(rafId);
    elapsedMs = 0;
    display.textContent = fmt(0);
    setButtons();
  });

  // ===== List UI =====
  function render() {
    listEl.innerHTML = "";

    for (const r of records) {
      const item = document.createElement("div");
      item.className = "item";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = r.selected;
      cb.addEventListener("change", () => {
        r.selected = cb.checked;
        save();
        updateSummary();
      });

      const meta = document.createElement("div");
      meta.className = "meta";

      const top = document.createElement("div");
      top.className = "top";

      const dur = document.createElement("span");
      dur.className = "dur";
      dur.textContent = fmt(r.ms);

      const label = document.createElement("input");
      label.type = "text";
      label.value = r.label;
      label.placeholder = "ラベル（空OK）";
      label.className = "record-label";   // ←これ追加
      label.addEventListener("input", () => {
        r.label = label.value;
        save();
      });

      top.appendChild(dur);
      top.appendChild(label);

      const small = document.createElement("small");
      small.textContent = new Date(r.createdAt).toLocaleString("ja-JP");

      meta.appendChild(top);
      meta.appendChild(small);

      const actions = document.createElement("div");
      actions.className = "actions";

      const delBtn = document.createElement("button");
      delBtn.className = "danger";
      delBtn.textContent = "削除";
      delBtn.addEventListener("click", () => {
        records = records.filter(x => x.id !== r.id);
        save();
        render();
      });

      actions.appendChild(delBtn);

      item.appendChild(cb);
      item.appendChild(meta);
      item.appendChild(actions);

      listEl.appendChild(item);
    }

    updateSummary();
  }

  function updateSummary() {
    const selected = records.filter(r => r.selected);
    const sum = selected.reduce((a, r) => a + r.ms, 0);
    selCountEl.textContent = String(selected.length);
    selTotalEl.textContent = fmt(sum);
  }

  selectAllBtn.addEventListener("click", () => {
    records.forEach(r => r.selected = true);
    save();
    render();
  });

  clearSelBtn.addEventListener("click", () => {
    records.forEach(r => r.selected = false);
    save();
    render();
  });

  deleteSelBtn.addEventListener("click", () => {
    const before = records.length;
    records = records.filter(r => !r.selected);
    if (records.length === before) return;
    save();
    render();
  });

  clearAllBtn.addEventListener("click", () => {
    records = [];
    save();
    render();
  });

  // init
  display.textContent = fmt(0);
  setButtons();
  render();
})();
</script>
</body>
</html>

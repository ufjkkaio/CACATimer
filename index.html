<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Time Logger</title>
  <link rel="stylesheet" href="./index.css">
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#12151c">
  <!-- iOS向け（あると見た目が良い） -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="./img/icon-192.png">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

// ===== Storage =====
const KEY = "time_logger_records_v1";

function loadRecords() {
  try {
    const raw = localStorage.getItem(KEY);
    const parsed = raw ? JSON.parse(raw) : [];
    if (!Array.isArray(parsed)) return [];
    return parsed.map(r => ({
      id: String(r.id ?? crypto.randomUUID()),
      label: String(r.label ?? ""),
      ms: Number.isFinite(r.ms) ? r.ms : 0,
      createdAt: Number.isFinite(r.createdAt) ? r.createdAt : Date.now(),
      selected: !!r.selected,
    }));
  } catch {
    return [];
  }
}

function saveRecords(records) {
  localStorage.setItem(KEY, JSON.stringify(records));
}

function fmt(ms) {
  const sign = ms < 0 ? "-" : "";
  ms = Math.abs(ms);

  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  const d1 = Math.floor((ms % 1000) / 10); // 10ms単位（0-99）

  const hh = String(h).padStart(2, "0");
  const mm = String(m).padStart(2, "0");
  const ss = String(s).padStart(2, "0");
  const dd = String(d1).padStart(2, "0"); // 2桁表示
  return `${sign}${hh}:${mm}:${ss}.${dd}`;
}

const TEXT = {
  ja: {
    title: "Time Logger（計測→記録→選択合計）",
    start: "Start",
    stop: "Stop & Save",
    labelPlaceholder: "今回のラベル（例：英語、JS、筋トレ）",
    memo: "※ Stop時にこのラベルで保存（空でもOK）",
    selectedCountL: "選択件数",
    selectedTotalL: "選択合計",
    selectAllBtn: "全選択",
    clearSelBtn: "選択解除",
    deleteSelBtn: "選択削除",
    clearAllBtn: "全削除",
    delete: "削除",
    labelPlaceholderRecord: "ラベル（空OK）"
  },
  pt: {
    title: "Time Logger",
    start: "Start",
    stop: "Stop & Save",
    labelPlaceholder: "Label (optional)",
    memo: "※ O rótulo será salvo ao pressionar \"Stop\" (opcional)",
    selectedCountL: "Selecionar",
    selectedTotalL: "Total Time",
    selectAllBtn: "Selecionar tudo",
    clearSelBtn: "Limpar seleção",
    deleteSelBtn: "Excluir selecionados",
    clearAllBtn: "Excluir tudo",
    delete: "Excluir",
    labelPlaceholderRecord: "Label (optional)"
  }
};

function RecordItem({ record, onUpdate, onDelete, t }) {
  const handleCheckboxChange = (e) => {
    onUpdate({ ...record, selected: e.target.checked });
  };

  const handleLabelChange = (e) => {
    onUpdate({ ...record, label: e.target.value });
  };

  return (
    <div className="item">
      <input
        type="checkbox"
        checked={record.selected}
        onChange={handleCheckboxChange}
      />
      <div className="meta">
        <div className="top">
          <span className="dur">{fmt(record.ms)}</span>
          <input
            type="text"
            value={record.label}
            onChange={handleLabelChange}
            placeholder={t("labelPlaceholderRecord")}
            className="record-label"
          />
        </div>
        <small>{new Date(record.createdAt).toLocaleString("ja-JP")}</small>
      </div>
      <div className="actions">
        <button className="danger" onClick={() => onDelete(record.id)}>
          {t("delete")}
        </button>
      </div>
    </div>
  );
}

function TimeLoggerApp() {
  const [records, setRecords] = useState(loadRecords);
  const [running, setRunning] = useState(false);
  const [displayTime, setDisplayTime] = useState(0);
  const [labelInput, setLabelInput] = useState("");
  const [currentLang, setCurrentLang] = useState("ja");

  const startAtRef = useRef(0);
  const elapsedMsRef = useRef(0);
  const rafIdRef = useRef(null);

  const t = (key) => TEXT[currentLang][key] || key;

  useEffect(() => {
    document.title = t("title");
  }, [currentLang]);

  useEffect(() => {
    saveRecords(records);
  }, [records]);

  useEffect(() => {
    if (!running) return;

    const tick = () => {
      const now = performance.now();
      const ms = elapsedMsRef.current + (now - startAtRef.current);
      setDisplayTime(ms);
      rafIdRef.current = requestAnimationFrame(tick);
    };

    rafIdRef.current = requestAnimationFrame(tick);

    return () => {
      if (rafIdRef.current) {
        cancelAnimationFrame(rafIdRef.current);
      }
    };
  }, [running]);

  const handleStart = () => {
    setRunning(true);
    startAtRef.current = performance.now();
    elapsedMsRef.current = 0;
  };

  const handleStop = () => {
    if (!running) return;
    setRunning(false);
    if (rafIdRef.current) {
      cancelAnimationFrame(rafIdRef.current);
    }

    const now = performance.now();
    const total = elapsedMsRef.current + (now - startAtRef.current);
    elapsedMsRef.current = 0;
    setDisplayTime(0);

    const label = labelInput.trim();
    const newRecord = {
      id: crypto.randomUUID(),
      label,
      ms: Math.max(0, Math.round(total)),
      createdAt: Date.now(),
      selected: false
    };
    setRecords(prev => [newRecord, ...prev]);
    setLabelInput("");
  };

  const handleRecordUpdate = (updatedRecord) => {
    setRecords(prev =>
      prev.map(r => r.id === updatedRecord.id ? updatedRecord : r)
    );
  };

  const handleRecordDelete = (id) => {
    setRecords(prev => prev.filter(r => r.id !== id));
  };

  const selectedRecords = records.filter(r => r.selected);
  const selectedSum = selectedRecords.reduce((a, r) => a + r.ms, 0);

  const handleSelectAll = () => {
    setRecords(prev => prev.map(r => ({ ...r, selected: true })));
  };

  const handleClearSelection = () => {
    setRecords(prev => prev.map(r => ({ ...r, selected: false })));
  };

  const handleDeleteSelected = () => {
    setRecords(prev => prev.filter(r => !r.selected));
  };

  const handleClearAll = () => {
    setRecords([]);
  };

  const handleLangChange = (lang) => {
    setCurrentLang(lang);
  };

  return (
    <div className="wrap">
      <h1 id="title">{t("title")}</h1>
      <div className="lang-switch">
        <a href="#" onClick={(e) => { e.preventDefault(); handleLangChange("ja"); }}>
          日本語
        </a>
        <a href="#" onClick={(e) => { e.preventDefault(); handleLangChange("pt"); }}>
          Português
        </a>
      </div>

      <div className="card">
        <div className="row timerTop" style={{ justifyContent: "space-between" }}>
          <div className="time">{fmt(displayTime)}</div>
          <div className="row botan">
            <button
              className="main-botan"
              onClick={handleStart}
              disabled={running}
            >
              {t("start")}
            </button>
            <button
              className="secondary main-botan"
              onClick={handleStop}
              disabled={!running}
            >
              {t("stop")}
            </button>
          </div>
        </div>

        <div className="divider"></div>

        <div className="row">
          <input
            type="text"
            value={labelInput}
            onChange={(e) => setLabelInput(e.target.value)}
            placeholder={t("labelPlaceholder")}
          />
          <span className="muted">{t("memo")}</span>
        </div>
      </div>

      <div className="card">
        <div className="summary">
          <div className="pill">
            <span>{t("selectedCountL")}：</span>
            <b>{selectedRecords.length}</b>
          </div>
          <div className="pill">
            <span>{t("selectedTotalL")}：</span>
            <b>{fmt(selectedSum)}</b>
          </div>
          <div className="row">
            <button className="secondary" onClick={handleSelectAll}>
              {t("selectAllBtn")}
            </button>
            <button className="secondary" onClick={handleClearSelection}>
              {t("clearSelBtn")}
            </button>
            <button className="danger" onClick={handleDeleteSelected}>
              {t("deleteSelBtn")}
            </button>
            <button className="danger" onClick={handleClearAll}>
              {t("clearAllBtn")}
            </button>
          </div>
        </div>
      </div>

      <div className="list">
        {records.map(record => (
          <RecordItem
            key={record.id}
            record={record}
            onUpdate={handleRecordUpdate}
            onDelete={handleRecordDelete}
            t={t}
          />
        ))}
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<TimeLoggerApp />);

if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js");
  });
}
</script>
</body>
</html>

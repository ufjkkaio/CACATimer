<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Time Logger</title>
  <link rel="stylesheet" href="./index.css">
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#12151c">
  <!-- iOS向け（あると見た目が良い） -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="./img/icon-192.p">
</head>
<body>
  <div class="wrap">
  <h1>Time Logger（計測→記録→選択合計）</h1>

  <div class="card">
    <div class="row timerTop" style="justify-content: space-between;">
      <div class="time" id="display">00:00:00.0</div>
      <div class="row botan">
        <button class="main-botan" id="startBtn">Start</button>
        <button  id="stopBtn" class="secondary main-botan" disabled>Stop & Save</button>
        <!-- <button id="resetBtn" class="secondary" disabled>Reset</button> -->
      </div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <input id="labelInput" type="text" placeholder="今回のラベル（例：英語、JS、筋トレ）" />
      <span class="muted">※ Stop時にこのラベルで保存（空でもOK）</span>
    </div>
  </div>

  <div class="card">
    <div class="summary">
      <div class="pill">選択件数：<b id="selCount">0</b></div>
      <div class="pill">選択合計：<b id="selTotal">00:00:00.0</b></div>
      <div class="row">
        <button id="selectAllBtn" class="secondary">全選択</button>
        <button id="clearSelBtn" class="secondary">選択解除</button>
        <button id="deleteSelBtn" class="danger">選択削除</button>
        <button id="clearAllBtn" class="danger">全削除</button>
      </div>
    </div>
  </div>

  <div class="list" id="list"></div>
</div>

<script>
(() => {
  // ===== Storage =====
  const KEY = "time_logger_records_v1";

  /** @type {{id:string,label:string,ms:number,createdAt:number,selected:boolean}[]} */
  let records = load();

  function load() {
    try {
      const raw = localStorage.getItem(KEY);
      const parsed = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(parsed)) return [];
      return parsed.map(r => ({
        id: String(r.id ?? crypto.randomUUID()),
        label: String(r.label ?? ""),
        ms: Number.isFinite(r.ms) ? r.ms : 0,
        createdAt: Number.isFinite(r.createdAt) ? r.createdAt : Date.now(),
        selected: !!r.selected,
      }));
    } catch {
      return [];
    }
  }

  function save() {
    localStorage.setItem(KEY, JSON.stringify(records));
  }

  // ===== Timer =====
  let running = false;
  let startAt = 0;      // performance.now()
  let elapsedMs = 0;    // accumulated ms
  let rafId = null;

  const display = document.getElementById("display");
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const labelInput = document.getElementById("labelInput");

  const listEl = document.getElementById("list");
  const selCountEl = document.getElementById("selCount");
  const selTotalEl = document.getElementById("selTotal");

  const selectAllBtn = document.getElementById("selectAllBtn");
  const clearSelBtn = document.getElementById("clearSelBtn");
  const deleteSelBtn = document.getElementById("deleteSelBtn");
  const clearAllBtn = document.getElementById("clearAllBtn");

  function fmt(ms) {
    const sign = ms < 0 ? "-" : "";
    ms = Math.abs(ms);

    const totalSec = Math.floor(ms / 1000);
    const h = Math.floor(totalSec / 3600);
    const m = Math.floor((totalSec % 3600) / 60);
    const s = totalSec % 60;
    const d1 = Math.floor((ms % 1000) / 100); // 0-9

    const hh = String(h).padStart(2, "0");
    const mm = String(m).padStart(2, "0");
    const ss = String(s).padStart(2, "0");
    return `${sign}${hh}:${mm}:${ss}.${d1}`;
  }

  function tick() {
    if (!running) return;
    const now = performance.now();
    const ms = elapsedMs + (now - startAt);
    display.textContent = fmt(ms);
    rafId = requestAnimationFrame(tick);
  }

  function setButtons() {
    startBtn.disabled = running;
    stopBtn.disabled = !running;
  }

  startBtn.addEventListener("click", () => {
    running = true;
    startAt = performance.now();
    setButtons();
    tick();
  });

  stopBtn.addEventListener("click", () => {
    if (!running) return;
    running = false;
    if (rafId) cancelAnimationFrame(rafId);

    const now = performance.now();
    const total = elapsedMs + (now - startAt);
    elapsedMs = 0;
    display.textContent = fmt(0);
    setButtons();

    const label = labelInput.value.trim();
    const rec = {
      id: crypto.randomUUID(),
      label,
      ms: Math.max(0, Math.round(total)),
      createdAt: Date.now(),
      selected: false
    };
    records.unshift(rec);
    save();
    render();
  });

  // ===== List UI =====
  function render() {
    listEl.innerHTML = "";

    for (const r of records) {
      const item = document.createElement("div");
      item.className = "item";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = r.selected;
      cb.addEventListener("change", () => {
        r.selected = cb.checked;
        save();
        updateSummary();
      });

      const meta = document.createElement("div");
      meta.className = "meta";

      const top = document.createElement("div");
      top.className = "top";

      const dur = document.createElement("span");
      dur.className = "dur";
      dur.textContent = fmt(r.ms);

      const label = document.createElement("input");
      label.type = "text";
      label.value = r.label;
      label.placeholder = "ラベル（空OK）";
      label.className = "record-label";   // ←これ追加
      label.addEventListener("input", () => {
        r.label = label.value;
        save();
      });

      top.appendChild(dur);
      top.appendChild(label);

      const small = document.createElement("small");
      small.textContent = new Date(r.createdAt).toLocaleString("ja-JP");

      meta.appendChild(top);
      meta.appendChild(small);

      const actions = document.createElement("div");
      actions.className = "actions";

      const delBtn = document.createElement("button");
      delBtn.className = "danger";
      delBtn.textContent = "削除";
      delBtn.addEventListener("click", () => {
        records = records.filter(x => x.id !== r.id);
        save();
        render();
      });

      actions.appendChild(delBtn);

      item.appendChild(cb);
      item.appendChild(meta);
      item.appendChild(actions);

      listEl.appendChild(item);
    }

    updateSummary();
  }

  function updateSummary() {
    const selected = records.filter(r => r.selected);
    const sum = selected.reduce((a, r) => a + r.ms, 0);
    selCountEl.textContent = String(selected.length);
    selTotalEl.textContent = fmt(sum);
  }

  selectAllBtn.addEventListener("click", () => {
    records.forEach(r => r.selected = true);
    save();
    render();
  });

  clearSelBtn.addEventListener("click", () => {
    records.forEach(r => r.selected = false);
    save();
    render();
  });

  deleteSelBtn.addEventListener("click", () => {
    const before = records.length;
    records = records.filter(r => !r.selected);
    if (records.length === before) return;
    save();
    render();
  });

  clearAllBtn.addEventListener("click", () => {
    records = [];
    save();
    render();
  });

  // init
  display.textContent = fmt(0);
  setButtons();
  render();
})();

  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./service-worker.js");
    });
  }

</script>
</body>
</html>
